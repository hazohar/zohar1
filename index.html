<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>××ª×¨ ×—×•××©×™× â€” ×× ×”×œ ×¤×¨×©× ×™×</title>
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0e1629;
      --card:#16233d;
      --accent:#fbbf24;
      --border:#24385c;
      --text:#f1f5f9;
      --status-none: #7f8c8d; /* ××¤×•×¨ */
      --status-text: #3498db; /* ×›×—×•×œ */
      --status-proofread: #f39c12; /* ×›×ª×•× */
      --status-edit: #e74c3c; /* ××“×•× */
      --status-review: #8e44ad; /* ×¡×’×•×œ */
      --status-ready: #2ecc71; /* ×™×¨×•×§ */
    }
    *{box-sizing:border-box;font-family:'Heebo',Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column}
    header{background:#111827;padding:12px 24px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
    h1{margin:0;font-size:22px}
    /* ×©×™× ×•×™: ×”×ª×××ª ×’×•×“×œ ×”×˜×•×¨×™× */
    main{flex:1;display:grid;grid-template-columns:250px 2fr 1fr;overflow:hidden;}
    aside,section{overflow:auto}
    .sidebar{background:var(--card);padding:12px;border-inline-end:1px solid var(--border)}
    .main{padding:18px;overflow:auto;display:flex;flex-direction:column}
    .panel{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
    .right{background:var(--card);border-inline-start:1px solid var(--border);padding:16px;display:flex;flex-direction:column}
    .chumash,.parsha{display:block;padding:8px 10px;border-radius:6px;color:inherit;text-decoration:none;margin-bottom:6px;cursor:pointer}
    .chumash:hover,.parsha:hover{background:rgba(255,255,255,0.05)}
    ul{list-style:none;padding:0;margin:0}
    li{padding:8px;border-bottom:1px solid rgba(255,255,255,0.06);cursor:pointer;border-radius:6px}
    li:hover{background:rgba(255,255,255,0.05)}
    .commentators ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      /* ×©×™× ×•×™: ×¡×™×“×•×¨ ×‘-4 ×¢××•×“×•×ª */
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .commentators li {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      text-align: center;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px;
    }
    .commentators li > * {
      margin-bottom: 5px;
    }
    /* ×©×™× ×•×™: ×”×›×œ×œ ×”×—×“×© ×œ×”×ª×××ª ×©× ×”××¤×¨×© */
    .commentators li > span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      font-size: 14px;
    }
    .commentators li > span:is(.is-small-font) {
      font-size: 11px;
    }
    .commentators li .buttons {
      display: flex;
      gap: 5px;
    }
    .status-label {
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 4px;
      color: white;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    button{background:var(--accent);border:none;padding:6px 10px;border-radius:6px;cursor:pointer;color:#000;font-weight:600}
    .muted-btn{background:transparent;border:1px solid var(--border);color:var(--text)}
    .delete-btn{background:#e74c3c;color:white}
    .reset-btn{background:#e74c3c;color:white}
    .back-btn{display:block;margin-bottom:10px}
    textarea{width:100%;height:120px;background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px;resize:vertical}
    .top-actions{display:flex;gap:10px}
    .content-card{
        background:#0b1220;
        border:1px solid var(--border);
        border-radius:12px;
        padding:12px;
        margin-bottom:12px;
        box-shadow:inset 0 0 8px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
    }
    .content-card h4{margin:0 0 6px;font-size:16px;color:var(--accent)}
    .content-card p{margin:0;font-size:14px;line-height:1.4;white-space:pre-wrap}
    .content-card-actions {
        margin-top: 10px;
        align-self: flex-end;
        display: flex;
        gap: 5px;
    }
    #editorArea{margin-bottom:16px}
    .status-dropdown {
      position: absolute;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 6px;
      z-index: 100;
      min-width: 150px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      top: 0;
      right: 100%;
    }
    .status-dropdown button {
      width: 100%;
      text-align: right;
      background: none;
      border: none;
      color: var(--text);
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
    }
    .status-dropdown button:hover {
      background: rgba(255,255,255,0.05);
    }
  </style>
</head>
<body>
  <header>
    <h1>×—××©×ª ×—×•××©×™ ×ª×•×¨×” â€” ×× ×”×œ ×¤×¨×©× ×™×</h1>
    <div class="top-actions">
      <button id="exportAll">×™×™×¦×/×”×•×¨×“</button>
      <button class="muted-btn" id="importBtn">×˜×¢×™× ×”</button>
      <button class="reset-btn" id="resetAll">××™×¤×•×¡ ×”×›×œ</button>
      <input type="file" id="importFile" accept="application/json" style="display:none">
    </div>
  </header>
  <main>
    <aside class="sidebar">
      <h3 id="sidebarTitle">×—×•××©×™×</h3>
      <nav id="navList"></nav>
    </aside>
    <section class="main">
      <div id="editorArea" class="panel" style="display:none;flex-direction:column">
        <label>××¤×¨×©: <strong id="editorCommentator"></strong></label>
        <textarea id="editorText" placeholder="×›×ª×•×‘ ×›××Ÿ..."></textarea>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="saveBtn">×©××•×¨</button>
          <button class="muted-btn" id="clearBtn">× ×§×”</button>
        </div>
      </div>
      <div id="savedContent" class="panel"><h3>×ª×•×›×Ÿ ×©××•×¨</h3><div id="contentDisplay"></div></div>
    </section>
    <aside class="right">
      <div>
        <h3 id="sideTitle">×¤×¨×©×” ×•××¤×¨×©</h3>
        <div id="commentatorList" class="commentators"></div>
      </div>
    </aside>
  </main>
  <script>
// ×”×§×•×“ ×”×§×‘×•×¢ ×©×œ×š ××”×—×œ×§ ×”×¢×œ×™×•×Ÿ ×©×œ ×”×¡×§×¨×™×¤×˜, ×¢×“ ×œ××©×ª× ×™×
const CHUMASHIM = [
    {key:'bereishit',title:'×‘×¨××©×™×ª',parshiot:['×‘×¨××©×™×ª','× ×—','×œ×š ×œ×š','×•×™×¨×','×—×™×™ ×©×¨×”','×ª×•×œ×“×•×ª','×•×™×¦×','×•×™×©×œ×—','×•×™×©×‘','××§×¥','×•×™×’×©','×•×™×—×™']},
    {key:'shemot',title:'×©××•×ª',parshiot:['×©××•×ª','×•××¨×','×‘×','×‘×©×œ×—','×™×ª×¨×•','××©×¤×˜×™×','×ª×¨×•××”','×ª×¦×•×”','×›×™ ×ª×©×','×•×™×§×”×œ','×¤×§×•×“×™']},
    {key:'vayikra',title:'×•×™×§×¨×',parshiot:['×•×™×§×¨×','×¦×•','×©××™× ×™','×ª×–×¨×™×¢','××¦×•×¨×¢','××—×¨×™ ××•×ª','×§×“×•×©×™×','×××•×¨','×‘×”×¨','×‘×—×•×§×•×ª×™']},
    {key:'bamidbar',title:'×‘××“×‘×¨',parshiot:['×‘××“×‘×¨','×‘×”×¢×œ×ª×š','×©×œ×—','×§×¨×—','×—×•×§×ª','×‘×œ×§','×¤× ×—×¡','××˜×•×ª','××¡×¢×™']},
    {key:'devarim',title:'×“×‘×¨×™×',parshiot:['×“×‘×¨×™×','×•××ª×—× ×Ÿ','×¢×§×‘','×¨××”','×©×•×¤×˜×™×','×›×™ ×ª×¦×','×›×™ ×ª×‘×•×','× ×¦×‘×™×','×•×™×œ×š','×”××–×™× ×•','×•×–××ª ×”×‘×¨×›×”']}
];
const COMMENTATORS = ['××•×¨ ×™×§×¨','×’×œ×™×•×Ÿ ×××•×¨ ×”×—××”','×’×œ×™×•× ×•×ª (×™×œ×§×•×˜ ×”×¢×¨×•×ª)','×”×’×”×•×ª ×”×’×¨"×','×”×’×”×•×ª ×¨×—"×• (×œ×¨×—"×• ×”×××™×ª×™)','×”×’×”×•×ª ×”×¨×"×–','×–×•×”×¨ +× ×™×§×•×“ +×©× ×•"×¡','×–×•×”×¨ ××•×¨ ×™×§×¨','×–×•×”×¨ ×”×¨×§×™×¢','×™×”×œ ××•×¨','×™×•×“×¢×™ ×‘×™× ×”','×›×ª× ×¤×–','××¡×•×¨×ª ×”×–×•×”×¨','××§×“×© ××œ×š','× ×–×¨ ×™×©×¨××œ','×§×¨× ×™ ××•×¨','×¨×"×’ ×××•×¨ ×”×—××”','×¨×—"×• ×××•×¨ ×”×—××”','×¨×"×','×¨×"×–','×¨×"×§','×××•×¨ ×”×—××”','×¨××“"×œ','×¨×× ××©×§×œ×•×‘','×©××Ÿ ×©×©×•×Ÿ','×©×¢×¨ ××××¨×™ ×¨×©×‘"×™','×©×¢×ª ×¨×¦×•×Ÿ','×ª×•×¨×” ××•×¨'];
const STATUS_OPTIONS = [
    { key: 'none', text: '××™×Ÿ ×‘×›×œ×œ', color: 'var(--status-none)' },
    { key: 'text', text: '×˜×§×¡×˜', color: 'var(--status-text)' },
    { key: 'proofread', text: '×”×’×”×”', color: 'var(--status-proofread)' },
    { key: 'edit', text: '×¢×¨×™×›×”', color: 'var(--status-edit)' },
    { key: 'review', text: '×‘×™×§×•×¨×ª', color: 'var(--status-review)' },
    { key: 'ready', text: '××•×›×Ÿ ×œ×¢×™××•×“', color: 'var(--status-ready)' }
];
const COMMENTATOR_DRIVE_LINKS = {
    '××•×¨ ×™×§×¨': '#',
    '×’×œ×™×•×Ÿ ×××•×¨ ×”×—××”': '#',
    '×’×œ×™×•× ×•×ª (×™×œ×§×•×˜ ×”×¢×¨×•×ª)': '#',
    '×”×’×”×•×ª ×”×’×¨"×': '#',
    '×”×’×”×•×ª ×¨×—"×• (×œ×¨×—"×• ×”×××™×ª×™)': '#',
    '×”×’×”×•×ª ×”×¨×"×–': '#',
    '×–×•×”×¨ +× ×™×§×•×“ +×©× ×•"×¡': '#',
    '×–×•×”×¨ ××•×¨ ×™×§×¨': '#',
    '×–×•×”×¨ ×”×¨×§×™×¢': '#',
    '×™×”×œ ××•×¨': '#',
    '×™×•×“×¢×™ ×‘×™× ×”': '#',
    '×›×ª× ×¤×–': '#',
    '××¡×•×¨×ª ×”×–×•×”×¨': '#',
    '××§×“×© ××œ×š': '#',
    '× ×–×¨ ×™×©×¨××œ': '#',
    '×§×¨× ×™ ××•×¨': '#',
    '×¨×"×’ ×××•×¨ ×”×—××”': '#',
    '×¨×—"×• ×××•×¨ ×”×—××”': '#',
    '×¨×"×': '#',
    '×¨×"×–': '#',
    '×¨×"×§': '#',
    '×××•×¨ ×”×—××”': '#',
    '×¨××“"×œ': '#',
    '×¨×× ××©×§×œ×•×‘': '#',
    '×©××Ÿ ×©×©×•×Ÿ': '#',
    '×©×¢×¨ ××××¨×™ ×¨×©×‘"×™': '#',
    '×©×¢×ª ×¨×¦×•×Ÿ': '#',
    '×ª×•×¨×” ××•×¨': '#'
};

// ××©×ª× ×™× DOM
const navList = document.getElementById('navList');
const sidebarTitle = document.getElementById('sidebarTitle');
const commentatorListEl = document.getElementById('commentatorList');
const sideTitle = document.getElementById('sideTitle');
const editorArea = document.getElementById('editorArea');
const editorCommentator = document.getElementById('editorCommentator');
const editorText = document.getElementById('editorText');
const saveBtn = document.getElementById('saveBtn');
const clearBtn = document.getElementById('clearBtn');
const contentDisplay = document.getElementById('contentDisplay');

let current = { chumash: null, parsha: null, commentator: null };

// ××ª×—×•×œ
function init() {
    if (Object.keys(localStorage).length === 0) loadDataFromJSON();
    else renderChumashList();
}

// ×˜×¢×™× ×ª × ×ª×•× ×™× ××§×•×‘×¥ ×—×™×¦×•× ×™
async function loadDataFromJSON() {
    try {
        const response = await fetch('./DATA.json');
        if (!response.ok) throw new Error('Network response was not ok');
        const data = await response.json();
        for (let key in data) localStorage.setItem(key, data[key]);
        alert('× ×ª×•× ×™× × ×˜×¢× ×• ×‘×”×¦×œ×—×” ××§×•×‘×¥ DATA.json');
        renderChumashList();
    } catch (error) {
        console.error('Failed to load data from JSON:', error);
        alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×§×•×‘×¥ ×”×—×™×¦×•× ×™. ×˜×•×¢×Ÿ ××ª ×”×××©×§ ×¨×™×§.');
        renderChumashList();
    }
}

// ×¨×©×™××ª ×—×•××©×™×
function renderChumashList() {
    sidebarTitle.textContent = '×—×•××©×™×';
    navList.innerHTML = '';
    CHUMASHIM.forEach(c => {
        let a = document.createElement('a');
        a.className = 'chumash';
        a.textContent = c.title;
        a.onclick = e => { e.preventDefault(); openChumash(c); };
        navList.appendChild(a);
    });
    renderContent(null, null);
}

// ×¤×ª×™×—×ª ×—×•××©
function openChumash(c) {
    current.chumash = c.key; current.parsha = null;
    sidebarTitle.textContent = c.title;
    navList.innerHTML = '';

    let backBtn = document.createElement('button');
    backBtn.textContent = '×—×–×¨×” ×œ×—×•××©×™×';
    backBtn.className = 'muted-btn back-btn';
    backBtn.onclick = renderChumashList;
    navList.appendChild(backBtn);

    c.parshiot.forEach(p => {
        let a = document.createElement('a');
        a.className = 'parsha';
        a.textContent = p;
        a.onclick = e => { e.preventDefault(); openParsha(p); };
        navList.appendChild(a);
    });
    commentatorListEl.innerHTML = '';
    sideTitle.textContent = '×‘×—×¨ ×¤×¨×©×” ×•××¤×¨×©';
    editorArea.style.display = 'none';
    renderContent(null, null);
}

// ×¤×ª×™×—×ª ×¤×¨×©×”
function openParsha(p) {
    current.parsha = p;
    sideTitle.textContent = `×¤×¨×©×”: ${p}`;
    commentatorListEl.innerHTML = '';
    let ul = document.createElement('ul');
    COMMENTATORS.forEach(n => {
        let li = document.createElement('li');

        let nameWrapper = document.createElement('div');
        nameWrapper.className = 'commentator-name-wrapper';
        let span = document.createElement('span');
        span.textContent = n;
        if (n.length > 20) span.classList.add('is-small-font');

        const driveLink = COMMENTATOR_DRIVE_LINKS[n];
        if (driveLink) {
            const linkEl = document.createElement('a');
            linkEl.href = driveLink;
            linkEl.target = '_blank';
            linkEl.rel = 'noopener noreferrer';
            linkEl.innerHTML = 'ğŸ“‚';
            nameWrapper.appendChild(span);
            nameWrapper.appendChild(linkEl);
        } else nameWrapper.appendChild(span);

        let buttonsDiv = document.createElement('div');
        buttonsDiv.className = 'buttons';
        let editBtn = document.createElement('button');
        editBtn.textContent = '×¢×¨×•×š';
        editBtn.onclick = e => { e.stopPropagation(); openEditor(n); };
        let statusBtn = document.createElement('button');
        statusBtn.textContent = '×‘×—×¨ ××¦×‘';
        statusBtn.onclick = e => { e.stopPropagation(); openStatusSelector(n, statusBtn); };
        buttonsDiv.appendChild(editBtn);
        buttonsDiv.appendChild(statusBtn);

        let statusDiv = document.createElement('div');
        statusDiv.className = 'status-display';
        li.appendChild(nameWrapper);
        li.appendChild(statusDiv);
        li.appendChild(buttonsDiv);
        ul.appendChild(li);

        loadAndDisplayStatus(current.chumash, current.parsha, n, statusDiv);
    });
    commentatorListEl.appendChild(ul);
    editorArea.style.display = 'none';
    renderContent(current.chumash, current.parsha);
}

// ×˜×¢×™× ×ª ×¡×˜×˜×•×¡
function loadAndDisplayStatus(chumashKey, parshaName, commentatorName, element) {
    const statusKey = `torah::${chumashKey}::${parshaName}::${commentatorName}::status`;
    const savedStatusKey = localStorage.getItem(statusKey);
    const status = STATUS_OPTIONS.find(s => s.key === savedStatusKey) || STATUS_OPTIONS[0];
    element.innerHTML = `<span class="status-label" style="background-color: ${status.color};">${status.text}</span>`;
}

// ×¤×ª×™×—×ª ×‘×—×™×¨×ª ×¡×˜×˜×•×¡
function openStatusSelector(commentator, button) {
    document.querySelectorAll('.status-dropdown').forEach(d => d.remove());
    const dropdown = document.createElement('div');
    dropdown.className = 'status-dropdown';
    STATUS_OPTIONS.forEach(status => {
        const statusOptionBtn = document.createElement('button');
        statusOptionBtn.textContent = status.text;
        statusOptionBtn.onclick = e => {
            e.stopPropagation();
            saveStatus(commentator, status.key);
            dropdown.remove();
        };
        dropdown.appendChild(statusOptionBtn);
    });
    button.parentElement.style.position = 'relative';
    button.parentElement.appendChild(dropdown);
}

// ×©××™×¨×ª ×¡×˜×˜×•×¡
function saveStatus(commentator, statusKey

